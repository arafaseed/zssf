<div class="dashboard-container">
  <!-- --- START: Updated Welcome Header + Cards (Material + Tailwind, colorful) --- -->

<!-- Welcome Header -->
<div class="mb-6">
  <mat-card class="p-6 rounded-2xl shadow-lg border-0">
    <div class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold text-slate-800">Welcome back, Admin ðŸ‘‹</h1>
        <p class="text-sm text-slate-500">General summary and quick access to useful data</p>
      </div>
    </div>
  </mat-card>
</div>

<!-- Summary Cards Grid -->
<div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">

  <!-- Card 1 -->
  <mat-card class="p-4 rounded-2xl shadow-md transform hover:-translate-y-1 transition bg-gradient-to-r from-indigo-500 to-indigo-400 text-white">
    <div class="flex items-center justify-between">
      <div>
        <div class="flex items-center gap-2">
          <mat-icon>event_available</mat-icon>
          <h3 class="text-sm font-medium">Total Overall Bookings</h3>
        </div>
        <div class="mt-3 text-2xl font-bold">{{ totalBookings }}</div>
      </div>
      <button mat-flat-button aria-label="view bookings" (click)="goToBookingList()">
        <span>All</span>
        <mat-icon>arrow_forward</mat-icon>
      </button>
    </div>
  </mat-card>

  <!-- Card 2 -->
  <mat-card class="p-4 rounded-2xl shadow-md bg-gradient-to-r from-cyan-500 to-blue-400 text-white">
    <div>
      <div class="flex items-center gap-2">
        <mat-icon>people</mat-icon>
        <h3 class="text-sm font-medium">Number of Customers</h3>
      </div>
      <div class="mt-3 text-2xl font-bold">{{ totalUsers }}</div>
    </div>
  </mat-card>


  <!-- Card 4 -->
  <mat-card class="p-4 rounded-2xl shadow-md bg-gradient-to-r from-amber-500 to-orange-400 text-white">
    <div>
      <div class="flex items-center gap-2">
        <mat-icon>paid</mat-icon>
        <h3 class="text-sm font-medium">Total Revenue</h3>
      </div>
      <div class="mt-3 text-2xl font-bold">{{ totalRevenue | number:'1.0-0' }} TZS</div>
    </div>
  </mat-card>

  <!-- Card 5 -->
  <mat-card class="p-4 rounded-2xl shadow-md bg-gradient-to-r from-sky-500 to-indigo-400 text-white">
    <div>
      <div class="flex items-center gap-2">
        <mat-icon>calendar_today</mat-icon>
        <h3 class="text-sm font-medium">Revenue This Month</h3>
      </div>
      <div class="mt-2 text-sm">{{ monthlyLabel || 'â€“' }}</div>
      <div class="mt-2 text-xl font-semibold">{{ monthlyRevenue | number:'1.0-0' }} TZS</div>
    </div>
  </mat-card>

  <!-- Card 6 -->
  <mat-card class="p-4 rounded-2xl shadow-md bg-gradient-to-r from-fuchsia-500 to-pink-400 text-white">
    <div>
      <div class="flex items-center gap-2">
        <mat-icon>location_on</mat-icon>
        <h3 class="text-sm font-medium">Most Overall Booked Venue</h3>
      </div>
      <div class="mt-3 text-lg font-semibold">{{ mostBookedVenue?.venueName || 'â€“' }}</div>
    </div>
  </mat-card>

  <!-- Card 7 -->
  <mat-card class="p-4 rounded-2xl shadow-md bg-gradient-to-r from-violet-500 to-purple-400 text-white">
    <div>
      <div class="flex items-center gap-2">
        <mat-icon>star</mat-icon>
        <h3 class="text-sm font-medium">Top 'COMPLETE' Booked Venue</h3>
      </div>
      <div class="mt-3 text-lg font-semibold">{{ mostBookedCompletedVenue?.venueName || 'â€“' }}</div>
    </div>
  </mat-card>

  <!-- Card 8 - Best Revenue Venue -->
  <mat-card class="p-4 rounded-2xl shadow-md border-l-4 border-yellow-400 bg-gradient-to-r from-green-50 to-green-200">
    <div class="flex items-start justify-between">
      <div>
        <div class="flex items-center gap-2 text-slate-700">
          <mat-icon class="text-amber-500">apartment</mat-icon>
          <h3 class="text-sm font-medium">Best Revenue Venue</h3>
        </div>

        <ng-container *ngIf="bestRevenueVenue; else none">
          <p class="mt-3 text-lg font-semibold text-slate-800">{{ bestRevenueVenue.venue.venueName }}</p>
          <p class="text-sm text-slate-800">Capacity: {{ bestRevenueVenue.venue.capacity }}</p>
          <p class="mt-2 text-xl font-bold text-emerald-800">{{ bestRevenueVenue.revenue | number:'1.0-0' }} TZS</p>
        </ng-container>
        <ng-template #none>
          <p class="text-gray-500">â€“</p>
        </ng-template>
      </div>
    </div>
  </mat-card>

  <!-- Available Venues (wide card) -->
  <mat-card class="col-span-1 sm:col-span-2 lg:col-span-2 p-4 rounded-2xl shadow-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <mat-icon class="text-cyan-600">event_available</mat-icon>
        <h3 class="text-base font-semibold">Available Venues</h3>
      </div>
      <div class="flex items-center gap-2">
        <input type="date" [(ngModel)]="availabilityDate" class="border px-2 py-1 rounded" />
        <button mat-flat-button color="primary" (click)="loadAvailableVenues()" [disabled]="!availabilityDate">Check</button>
        <button mat-stroked-button (click)="resetAvailableVenues()" *ngIf="availableVenues.length || availableVenueCount || availableError">Reset</button>
      </div>
    </div>

    <div class="mt-4">
      <p *ngIf="availableError" class="text-red-600">{{ availableError }}</p>
      <p *ngIf="availableVenueCount!==null && !availableError" class="font-semibold">Count: {{ availableVenueCount }}</p>

      <ul class="mt-3 space-y-2">
        <li *ngFor="let v of availableVenues" class="flex justify-between items-center p-3 border rounded-lg">
          <div>
            <div class="font-medium">{{ v.venueName }}</div>
            <div class="text-sm text-slate-500">Capacity: {{ v.capacity }}</div>
          </div>
          <mat-icon class="text-slate-400">chevron_right</mat-icon>
        </li>
        <li *ngIf="!availableVenues.length && availabilityDate && !availableError" class="italic text-gray-500">None Available</li>
      </ul>
    </div>
  </mat-card>

  <!-- Top Venues by Revenue -->
  <mat-card class="col-span-1 sm:col-span-2 lg:col-span-2 p-4 rounded-2xl shadow-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <mat-icon class="text-indigo-600">bar_chart</mat-icon>
        <h3 class="text-base font-semibold">Top Venues by Revenue</h3>
      </div>
    </div>

    <div class="mt-4 overflow-auto">
      <table class="w-full text-left">
        <thead class="text-slate-600">
          <tr>
            <th class="pb-2">Venue Name</th>
            <th class="pb-2">Revenue (TZS)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let v of topRevenueVenues" class="border-t">
            <td class="py-2">{{ v.venueName }}</td>
            <td class="py-2">{{ v.revenue | number:'1.0-0' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </mat-card>

  <!-- --- NEW CARD: Yearly Booking Stats --- -->
  <mat-card class="col-span-1 sm:col-span-2 lg:col-span-2 p-4 rounded-2xl shadow-md bg-gradient-to-r from-rose-50 to-rose-200 min-w-90">
    <div class="items-center justify-between">
      <div class="flex items-center gap-2">
        <mat-icon class="text-rose-600">timeline</mat-icon>
        <h3 class="text-base font-semibold">Yearly Booking Stats</h3>
      </div>

      <div class="flex items-center gap-2">
        <input type="number" min="2000" max="2100" [(ngModel)]="statsYear" class="border px-2 py-1 rounded w-28" />
        <button mat-flat-button color="accent" (click)="loadBookingStatsYear(statsYear)">Load</button>
      </div>
    </div>

    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
      <ng-container *ngFor="let s of yearlyStats">
        <div class="p-3 rounded-lg bg-white shadow-sm flex items-center justify-between">
          <div class="flex items-center gap-3">
            <mat-icon [class.text-green-600]="s.status==='COMPLETE'"
                      [class.text-yellow-600]="s.status==='PENDING'"
                      [class.text-red-600]="s.status==='CANCELLED' || s.status==='EXPIRED'"
                      [class.text-indigo-600]="s.status==='IN_PROGRESS'">circle</mat-icon>
            <div>
              <div class="text-sm font-medium">{{ s.status }}</div>
              <div class="text-lg font-bold">{{ s.count }}</div>
            </div>
          </div>
          <div class="w-20 h-2 bg-gray-100 rounded-full overflow-hidden">
            <!-- tiny bar representing count -->
            <div class="h-full bg-gradient-to-r from-rose-400 to-rose-600" [style.width]="statBarWidth(s.count)"></div>
          </div>
        </div>
      </ng-container>
    </div>
  </mat-card>

  <!-- --- NEW CARD: Monthly Booking Stats --- -->
  <mat-card class="col-span-1 sm:col-span-2 lg:col-span-2 p-4 rounded-2xl shadow-md bg-gradient-to-r from-sky-50 to-sky-200 min-w-90 ">
    <div class=" items-center justify-between">
      <div class="flex items-center gap-2">
        <mat-icon class="text-sky-600">date_range</mat-icon>
        <h3 class="text-base font-semibold">Monthly Booking Stats</h3>
      </div>

      <div class="flex items-center gap-2">
        <input type="month" [(ngModel)]="statsMonth" class="border px-2 py-1 rounded" />
        <button mat-flat-button color="primary" (click)="loadBookingStatsMonthFromInput()">Load</button>
      </div>
    </div>

    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
      <ng-container *ngFor="let s of monthlyStats">
        <div class="p-3 rounded-lg bg-white shadow-sm flex items-center justify-between">
          <div class="flex items-center gap-3">
            <mat-icon [class.text-green-600]="s.status==='COMPLETE'"
                      [class.text-yellow-600]="s.status==='PENDING'"
                      [class.text-red-600]="s.status==='CANCELLED' || s.status==='EXPIRED'"
                      [class.text-indigo-600]="s.status==='IN_PROGRESS'">circle</mat-icon>
            <div>
              <div class="text-sm font-medium">{{ s.status }}</div>
              <div class="text-lg font-bold">{{ s.count }}</div>
            </div>
          </div>
          <div class="w-20 h-2 bg-gray-100 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-sky-400 to-sky-600" [style.width]="statBarWidth(s.count)"></div>
          </div>
        </div>
      </ng-container>
    </div>
  </mat-card>

</div>
<!-- --- END: Updated Welcome Header + Cards --- -->



  <!-- Recent Bookings Table (also outside grid!) -->
  <div class="recent-activity mt-6" aria-live="polite" aria-relevant="all">

     <h2 class="text-xl font-semibold mt-4 mb-2 text-slate-800">
      Recent Bookings
    </h2>

    <!-- Filters (compact) -->
    <div class="search-filters flex flex-wrap items-center gap-3 bg-white rounded-lg shadow-md p-4"
      aria-label="Search Bookings">
      <input type="text" placeholder="Search by Phone" [(ngModel)]="searchPhone" aria-label="Search by Phone Number"
        class="px-3 py-2 rounded-lg border border-slate-300 min-w-[180px] focus:outline-none focus:ring-2 focus:ring-sky-400" />

      <input type="date" [(ngModel)]="searchDate" aria-label="Search by Start Date"
        class="px-3 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-sky-400" />

      <div class="flex items-center gap-2 ml-auto">
        <button mat-raised-button color="primary" (click)="searchBookings()" class="px-4 py-2 rounded-md">
          Search
        </button>
        <button mat-stroked-button color="warn" (click)="clearSearch()" class="px-4 py-2 rounded-md">
          Reset
        </button>

        <button mat-button (click)="goToBookingList()" class="ml-2 text-sm text-slate-600 hover:text-slate-800"
          aria-label="View all bookings">
          View all
        </button>
      </div>
    </div>

   

    <!-- Minimal Mat Table preview (last 5 bookings) -->
    <mat-card class="overflow-auto shadow-sm">
      <table mat-table [dataSource]="recentBookings" class="min-w-full table-auto divide-y divide-slate-200">

        <!-- Booking Code -->
        <ng-container matColumnDef="bookingCode">
          <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left text-sm font-medium text-slate-700">Code</th>
          <td mat-cell *matCellDef="let b" class="px-4 py-3 text-sm">{{ b.bookingCode }}</td>
        </ng-container>

        <!-- Booking Date (when the booking was placed) -->
        <ng-container matColumnDef="bookingDate">
          <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left text-sm font-medium text-slate-700">Booked On
          </th>
          <td mat-cell *matCellDef="let b" class="px-4 py-3 text-sm">
            {{ b.bookingDate || b.bookingDate | date:'shortDate' }}</td>
        </ng-container>

        <!-- Activity (venueActivityName) -->
        <ng-container matColumnDef="activity">
          <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left text-sm font-medium text-slate-700">Activity
          </th>
          <td mat-cell *matCellDef="let b" class="px-4 py-3 text-sm">{{ b.venueActivityName || '-' }}</td>
        </ng-container>

        <!-- Venue -->
        <ng-container matColumnDef="venueName">
          <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left text-sm font-medium text-slate-700">Venue
          </th>
          <td mat-cell *matCellDef="let b" class="px-4 py-3 text-sm">{{ b.venueName || b.venue?.venueName || 'N/A' }}
          </td>
        </ng-container>

        <!-- Customer Name -->
        <ng-container matColumnDef="customerName">
          <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left text-sm font-medium text-slate-700">Customer
          </th>
          <td mat-cell *matCellDef="let b" class="px-4 py-3 text-sm">{{ b.customer?.customerName }}</td>
        </ng-container>

        <!-- Customer Type -->
        <ng-container matColumnDef="customerType">
          <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left text-sm font-medium text-slate-700">Type</th>
          <td mat-cell *matCellDef="let b" class="px-4 py-3 text-sm">{{ b.customer?.customerType || '-' }}</td>
        </ng-container>

        <!-- Start Date -->
        <ng-container matColumnDef="startDate">
          <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left text-sm font-medium text-slate-700">Start
          </th>
          <td mat-cell *matCellDef="let b" class="px-4 py-3 text-sm">{{ b.startDate | date:'shortDate' }}</td>
        </ng-container>

        <!-- End Date -->
        <ng-container matColumnDef="endDate">
          <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left text-sm font-medium text-slate-700">End</th>
          <td mat-cell *matCellDef="let b" class="px-4 py-3 text-sm">{{ b.endDate | date:'shortDate' }}</td>
        </ng-container>

        <!-- Status (colored) -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left text-sm font-medium text-slate-700">Status
          </th>
          <td mat-cell *matCellDef="let b" class="px-4 py-3 text-sm">
            <span [ngStyle]="{ color: getStatusColor(b.bookingStatus) }" class="font-medium">
              {{ b.bookingStatus }}
            </span>
          </td>
        </ng-container>

        <!-- Reference / View Docs -->
        <ng-container matColumnDef="reference">
          <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left text-sm font-medium text-slate-700">Docs</th>
          <td mat-cell *matCellDef="let b" class="px-4 py-3 text-sm">
            <button mat-stroked-button color="primary" (click)="openReferenceDocs(b)"
              [disabled]="!(b.customer?.referenceDocument?.length)"
              [attr.aria-label]="'View reference document for booking ' + b.bookingCode" class="text-xs">
              View Docs
            </button>

            <app-pdf-viewer-overlay
  *ngIf="showPdfOverlay"
  #pdfOverlay
  [bookingId]="selectedBookingId"
  [bookingCode]="selectedBookingCode"
  [docs]="selectedDocs"
  [authToken]="pdfAuthToken"
  (closed)="closePdfPreview()"
  (click)="$event.stopPropagation()">
</app-pdf-viewer-overlay>

            
          </td>
        </ng-container>

        <!-- header and rows -->
        <tr mat-header-row
          *matHeaderRowDef="['bookingCode','bookingDate','activity','venueName','customerName','customerType','startDate','endDate','status','reference']">
        </tr>
        <tr mat-row
          *matRowDef="let row; columns: ['bookingCode','bookingDate','activity','venueName','customerName','customerType','startDate','endDate','status','reference'];"
          tabindex="0" class="hover:bg-slate-50"></tr>
      </table>
    </mat-card>

  </div>

</div>