<div class="max-w-7xl p-6 mx-auto space-y-6">
  <h1 class="text-2xl font-semibold text-slate-900">Policies Settings</h1>
  <p class="text-sm text-slate-600">Manage booking expiry, employee discount, and date blocking policies.</p>

  <!-- Grid for all three cards -->
  <div class="grid grid-cols-1 gap-6 md:grid-cols-3 md:items-start">

    <!-- Booking Expiry Card (compact, fixed visual height) -->
    <section class="p-5 bg-white shadow-xl rounded-2xl self-start flex flex-col min-h-[380px]">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="flex items-center gap-2 text-lg font-medium text-slate-800">
            <i-lucide-clock class="w-5 h-5 text-emerald-600"></i-lucide-clock>
            Booking Expiry
          </h2>
          <p class="mt-1 text-sm text-slate-500">Time until unpaid booking automatically expires.</p>
        </div>
        <button mat-icon-button (click)="loadExpiry()" title="Refresh">
          <i-lucide-refresh-cw class="w-5 h-5 text-slate-500"></i-lucide-refresh-cw>
        </button>
      </div>

      <div class="mt-4 text-sm text-slate-700 flex-1">
        <span class="font-semibold">Current:</span>
        <span *ngIf="!expiryLoading">{{ expiryHours }} hours
          <span *ngIf="expiryHours % 24 === 0">({{ expiryHours / 24 }} days)</span>
        </span>
        <mat-progress-spinner *ngIf="expiryLoading" diameter="20" mode="indeterminate"></mat-progress-spinner>
        <div *ngIf="showAsDays" class="mt-1 text-slate-600">
          Displayed as <span class="font-medium">{{ (expiryHours / 24) | number:'1.0-2' }}</span> days
        </div>
        <div *ngIf="expiryError" class="mt-2 text-red-600">{{ expiryError }}</div>
      </div>

      <form class="mt-4 space-y-3" [formGroup]="expiryForm" (ngSubmit)="saveExpiry()">
        <mat-form-field class="w-full">
          <mat-label>Hours</mat-label>
          <input matInput type="number" formControlName="hours" min="1" />
          <mat-hint>Enter hours (e.g. 24)</mat-hint>
        </mat-form-field>

        <div class="flex items-center gap-3 pt-2">
          <button mat-flat-button color="primary" type="submit" [disabled]="savingExpiry">
            <i-lucide-save class="w-4 h-4 mr-2"></i-lucide-save>
            {{ savingExpiry ? 'Saving...' : 'Save Expiry' }}
          </button>
          <button mat-stroked-button type="button" (click)="toggleShowAsDays()">
            {{ showAsDays ? 'Show as hours' : 'Show as days' }}
          </button>
        </div>
      </form>
    </section>

    <!-- Discount Policy Card (compact, fixed visual height) -->
    <section class="p-5 bg-white shadow-xl rounded-2xl self-start flex flex-col min-h-[380px]">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="flex items-center gap-2 text-lg font-medium text-slate-800">
            <i-lucide-percent class="w-5 h-5 text-amber-600"></i-lucide-percent>
            Discount Policy
          </h2>
          <p class="mt-1 text-sm text-slate-500">
            Set the employee discount rate and how many times per year it may be used.
          </p>
        </div>
        <div class="flex items-center gap-1">
          <button mat-icon-button (click)="loadDiscountPolicy()" title="Refresh">
            <i-lucide-refresh-cw class="w-5 h-5 text-slate-500"></i-lucide-refresh-cw>
          </button>
          <button mat-icon-button (click)="manualRefresh()" title="Manual Refresh Policy">
            <i-lucide-rotate-ccw class="w-5 h-5 text-slate-500"></i-lucide-rotate-ccw>
          </button>
        </div>
      </div>

      <div class="mt-4 text-sm text-slate-700 flex-1">
        <ng-container *ngIf="discountPolicy; else noPolicy">
          <div><span class="font-semibold">Year:</span> {{ discountPolicy.year }}</div>
          <div><span class="font-semibold">Rate:</span> {{ discountPolicy.discountRate * 100 | number:'1.0-2' }}%</div>
          <div><span class="font-semibold">Max Uses / year:</span> {{ discountPolicy.maxUsesPerYear }}</div>
          <div class="mt-1 text-xs text-slate-400">
            Created: {{ discountPolicy.createdAt | date:'medium' }}
          </div>
        </ng-container>
        <ng-template #noPolicy>
          <div class="text-slate-500">No discount policy found for current year.</div>
        </ng-template>
        <div *ngIf="discountError" class="mt-2 text-red-600">{{ discountError }}</div>
        <div *ngIf="refreshMessage" class="mt-2 text-emerald-600">{{ refreshMessage }}</div>
      </div>

      <form class="mt-4 space-y-3" [formGroup]="discountForm" (ngSubmit)="saveDiscountPolicy()">
        <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
          <mat-form-field class="w-full">
            <mat-label>Discount Rate (decimal)</mat-label>
            <input matInput type="number" step="0.01" formControlName="discountRate" placeholder="0.25 for 25%" />
            <mat-hint>Enter as decimal (e.g. 0.25 = 25%)</mat-hint>
          </mat-form-field>

          <mat-form-field class="w-full">
            <mat-label>Max Uses Per Year</mat-label>
            <input matInput type="number" formControlName="maxUsesPerYear" min="0" />
          </mat-form-field>
        </div>

        <div class="flex items-center gap-3 pt-2">
          <button mat-flat-button color="primary" type="submit" [disabled]="savingDiscount">
            <i-lucide-save class="w-4 h-4 mr-2"></i-lucide-save>
            {{ savingDiscount ? 'Saving...' : 'Save Discount' }}
          </button>
          <button mat-stroked-button type="button" (click)="loadDiscountPolicy()">Reload</button>
        </div>
      </form>
    </section>

    <!-- Block Date Card (expanding) -->
    <section class="p-5 bg-white shadow-xl rounded-2xl flex flex-col">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="flex items-center gap-2 text-lg font-medium text-slate-800">
            <i-lucide-calendar class="w-5 h-5 text-blue-600"></i-lucide-calendar>
            Block Date
          </h2>
          <p class="mt-1 text-sm text-slate-500">Block a date for venue bookings.</p>
        </div>
      </div>

      <div class="mt-4 flex-1">
        <app-block-date></app-block-date>
      </div>
    </section>

  </div>
</div>
