<!-- src/app/admin/pages/admin-policies.component.html -->
<div class="p-6 max-w-5xl mx-auto space-y-6">
  <h1 class="text-2xl font-semibold text-slate-900">Policies & Settings</h1>
  <p class="text-sm text-slate-600">Manage booking expiry and employee discount policy. Colors inspired by ZSSF; controls use Angular Material + Tailwind.</p>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- Booking Expiry Card -->
    <section class="bg-white rounded-2xl shadow-sm p-5 border">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-lg font-medium text-slate-800 flex items-center gap-2">
            <i-lucide-clock class="w-5 h-5 text-emerald-600"></i-lucide-clock>
            Booking Expiry
          </h2>
          <p class="text-sm text-slate-500 mt-1">Time until unpaid booking automatically expires.</p>
        </div>

        <div class="text-sm text-slate-500">
          <button mat-icon-button (click)="loadExpiry()" title="Refresh">
            <i-lucide-refresh-cw class="w-5 h-5"></i-lucide-refresh-cw>
          </button>
        </div>
      </div>

      <!-- current value -->
      <div class="mt-4">
        <div class="text-sm text-slate-700">
          <span class="font-semibold">Current:</span>
          <span *ngIf="!expiryLoading">{{ expiryHours }} hours
            <span *ngIf="expiryHours % 24 === 0">({{ expiryHours / 24 }} days)</span>
          </span>
          <mat-progress-spinner *ngIf="expiryLoading" diameter="20" mode="indeterminate"></mat-progress-spinner>
        </div>

        <div *ngIf="expiryError" class="mt-2 text-sm text-red-600">{{ expiryError }}</div>
      </div>

      <!-- form -->
      <form class="mt-4 space-y-3" [formGroup]="expiryForm" (ngSubmit)="saveExpiry()">
        <div class="flex gap-3 items-end">
          <div class="flex-1">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Hours</mat-label>
              <input matInput type="number" formControlName="hours" min="1" />
              <mat-hint>Enter hours (e.g. 24)</mat-hint>
            </mat-form-field>
          </div>

          <div class="flex-1">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Days (optional)</mat-label>
              <input matInput type="number" formControlName="days" min="1" />
              <mat-hint>Or set days (e.g. 2 â†’ 48 hours)</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button mat-flat-button color="primary" type="submit" [disabled]="savingExpiry">
            <i-lucide-save class="w-4 h-4 mr-2"></i-lucide-save>
            {{ savingExpiry ? 'Saving...' : 'Save Expiry' }}
          </button>

          <button mat-stroked-button type="button" (click)="toggleShowAsDays()">
            {{ showAsDays ? 'Show as hours' : 'Show as days' }}
          </button>

          <div *ngIf="showAsDays" class="text-sm text-slate-600 ml-auto">
            Displayed as <span class="font-medium">{{ (expiryHours / 24) | number:'1.0-2' }}</span> days
          </div>
        </div>
      </form>
    </section>

    <!-- Discount Policy Card -->
    <section class="bg-white rounded-2xl shadow-sm p-5 border">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-lg font-medium text-slate-800 flex items-center gap-2">
            <i-lucide-percent class="w-5 h-5 text-amber-600"></i-lucide-percent>
            Discount Policy
          </h2>
          <p class="text-sm text-slate-500 mt-1">Set the employee discount rate and how many times per year it may be used.</p>
        </div>

        <div class="flex items-center gap-2">
          <button mat-icon-button (click)="loadDiscountPolicy()" title="Refresh">
            <i-lucide-refresh-cw class="w-5 h-5"></i-lucide-refresh-cw>
          </button>
          <button mat-icon-button (click)="manualRefresh()" title="Manual Refresh Policy">
            <i-lucide-rotate-ccw class="w-5 h-5"></i-lucide-rotate-ccw>
          </button>
        </div>
      </div>

      <div class="mt-4">
        <div *ngIf="discountPolicy; else noPolicy">
          <div class="text-sm text-slate-700">
            <div><span class="font-semibold">Year:</span> {{ discountPolicy.year }}</div>
            <div><span class="font-semibold">Rate:</span> {{ discountPolicy.discountRate * 100 | number:'1.0-2' }}%</div>
            <div><span class="font-semibold">Max Uses / year:</span> {{ discountPolicy.maxUsesPerYear }}</div>
            <div class="text-xs text-slate-400 mt-1">Created: {{ discountPolicy.createdAt | date:'medium' }}</div>
          </div>
        </div>

        <ng-template #noPolicy>
          <div class="text-sm text-slate-500">No discount policy found for current year.</div>
        </ng-template>

        <div *ngIf="discountError" class="mt-2 text-sm text-red-600">{{ discountError }}</div>
        <div *ngIf="refreshMessage" class="mt-2 text-sm text-emerald-600">{{ refreshMessage }}</div>
      </div>

      <form class="mt-4 space-y-3" [formGroup]="discountForm" (ngSubmit)="saveDiscountPolicy()">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Discount Rate (decimal)</mat-label>
            <input matInput type="number" step="0.01" formControlName="discountRate" placeholder="0.25 for 25%" />
            <mat-hint>Enter as decimal (e.g. 0.25 = 25%)</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Max Uses Per Year</mat-label>
            <input matInput type="number" formControlName="maxUsesPerYear" min="0" />
          </mat-form-field>
        </div>

        <div class="flex items-center gap-3">
          <button mat-flat-button color="primary" type="submit" [disabled]="savingDiscount">
            <i-lucide-save class="w-4 h-4 mr-2"></i-lucide-save>
            {{ savingDiscount ? 'Saving...' : 'Save Discount' }}
          </button>

          <button mat-stroked-button type="button" (click)="loadDiscountPolicy()">Reload</button>

          <div class="ml-auto text-sm text-slate-500" *ngIf="discountPolicy">
            Current rate: <span class="font-medium">{{ discountPolicy.discountRate * 100 | number:'1.0-2' }}%</span>
          </div>
        </div>
      </form>
    </section>
  </div>
</div>
