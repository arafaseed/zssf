<h2 mat-dialog-title class="flex items-center justify-between gap-3">
  <span class="font-semibold">Book — {{ data?.venueName }}</span>
  <button mat-icon-button aria-label="close" (click)="cancel()">
    <i-lucide-x class="w-5 h-5"></i-lucide-x>
  </button>
</h2>

<mat-dialog-content class="px-4 py-3 max-h-[80vh] overflow-auto">
  <div class="text-sm text-slate-600 mb-3">
    <div *ngIf="data.mode === 'range'">Booking range:
      <strong>{{ data.start | date:'shortDate' }}</strong> →
      <strong>{{ data.end | date:'shortDate' }}</strong>
    </div>
    <div *ngIf="data.mode === 'single'">Selected date:
      <strong>{{ data.item?.date }}</strong>
    </div>
    <div>Activity: <strong>{{ data.activityName || '—' }}</strong></div>
  </div>

  <form [formGroup]="detailsForm" class="space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <mat-form-field class="w-full">
        <mat-label>Optional service</mat-label>
        <mat-select formControlName="optionalServiceId">
          <mat-option [value]="null">None</mat-option>
          <mat-option *ngFor="let s of optionalServices" [value]="s.serviceId">
            <!-- show name and price -->
            {{ s.optionalServiceName || s.serviceName }} — {{ s.price | number : '1.0-0' }} TZS
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field class="w-full">
        <mat-label>Customer type</mat-label>
        <mat-select formControlName="customerType">
          <mat-option value="INDIVIDUAL">Individual</mat-option>
          <mat-option value="ORGANIZATION">Organization</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field class="w-full">
        <mat-label>Customer name</mat-label>
        <input matInput formControlName="customerName" />
        <mat-error *ngIf="detailsForm.controls['customerName'].invalid">Required</mat-error>
      </mat-form-field>

      <mat-form-field class="w-full">
        <mat-label>Phone</mat-label>
        <input matInput formControlName="phoneNumber" maxlength="10" (input)="onPhoneInput($event)" />
        <mat-hint>10 digits, must start with 06, 07 or 08</mat-hint>
        <mat-error *ngIf="detailsForm.controls['phoneNumber'].hasError('required')">
          Required
        </mat-error>
        <mat-error *ngIf="detailsForm.controls['phoneNumber'].hasError('pattern')">
          Phone must be 10 digits and start with 06, 07 or 08
        </mat-error>
      </mat-form-field>

      <mat-form-field class="w-full">
        <mat-label>Email</mat-label>
        <input matInput formControlName="email" />
        <mat-error *ngIf="detailsForm.controls['email'].invalid">Valid email required</mat-error>
      </mat-form-field>

      <mat-form-field class="w-full">
        <mat-label>Address</mat-label>
        <input matInput formControlName="address" />
        <mat-error *ngIf="detailsForm.controls['address'].invalid">Required</mat-error>
      </mat-form-field>
    </div>

    <!-- PDF upload for organizations -->
    <div *ngIf="detailsForm.value.customerType === 'ORGANIZATION'" class="mt-2">
      <label class="block mb-1 text-sm font-medium">Reference document (PDF)</label>
      <input type="file" (change)="onFileSelected($event)" accept="application/pdf" />
      <div *ngIf="fileError" class="mt-1 text-sm text-rose-600">{{ fileError }}</div>
      <div *ngIf="attachedFile" class="mt-1 text-sm text-slate-600">Selected: {{ attachedFile.name }}</div>
    </div>

    <div class="flex items-center gap-3 mt-3">
      <mat-checkbox (change)="openEmployeeVerify()">I am an employee of ZSSF (verify for 25% discount)</mat-checkbox>
      <div *ngIf="employeeVerified" class="text-sm text-emerald-600 flex items-center gap-2">
        <i-lucide-check-circle class="w-4 h-4"></i-lucide-check-circle>
        Employee verified — discount applied ({{ discountRate * 100 }}%)
      </div>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end" class="px-4 pb-3">
  <button mat-button (click)="cancel()">Cancel</button>
  <button mat-flat-button color="primary" (click)="submitBooking()" [disabled]="isSubmitting">
    <i-lucide-send class="w-4 h-4 mr-2"></i-lucide-send> Submit Booking
  </button>
</mat-dialog-actions>
