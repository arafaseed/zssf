<h2 mat-dialog-title class="flex items-center justify-between gap-4">
  <span>Check & Create Booking</span>
  <button mat-icon-button aria-label="close" (click)="cancel()">
    <i-lucide-x-circle></i-lucide-x-circle>
  </button>
</h2>

<mat-dialog-content class="space-y-4 px-6 py-4 dialog-content-vertical-scroll">
  <!-- STEP: checking -->
  <div *ngIf="step === 'checking'">
    <p class="text-sm text-slate-700">Checking availability for:</p>
    <ul class="text-sm text-slate-600 space-y-1">
      <li><strong>Venue:</strong> {{ data.venueName }}</li>
      <li><strong>Activity:</strong> {{ data.activityName }}</li>
      <li><strong>Range:</strong> {{ data.start | date:'shortDate' }} - {{ data.end | date:'shortDate' }}</li>
      <li><strong>Times:</strong> {{ data.startTime }} - {{ data.endTime }}</li>
    </ul>

    <div class="py-6 text-center">
      <mat-progress-spinner diameter="48" mode="indeterminate"></mat-progress-spinner>
    </div>
  </div>

  <!-- STEP: chooseFromResponse -> show server response list where user can select -->
  <div *ngIf="step === 'chooseFromResponse'">
    <p class="text-sm text-amber-600">Your date range contains booked dates. Please select one of the dates below to continue, or cancel and try another range.</p>

    <mat-selection-list (selectionChange)="onSelectList($event)">
      <mat-list-option *ngFor="let it of availabilityResponse" [value]="it">
        <div class="flex items-center justify-between gap-4 h-10 ">
          <div>
            <div class="font-medium">{{ it.date }}</div>
            <div class="text-sm text-slate-600">
              <span *ngIf="it.flag === 'AVAILABLE_FOR_BOOKING'"><i-lucide-check-circle class="inline-block mr-1"></i-lucide-check-circle>Available</span>
              <span *ngIf="it.flag === 'ALREADY_BOOKED'"><i-lucide-x class="inline-block mr-1"></i-lucide-x>Booked</span>
            </div>

            <div *ngIf="it.flag === 'ALREADY_BOOKED'" class="text-xs text-slate-500 mt-1">
              <div>Booking: {{ it.bookingCode ?? '#' + (it.bookingId || 'N/A') }} | Status: {{ it.status }}</div>
              <div *ngIf="it.bookedStart">Booked time: {{ it.bookedStart }} - {{ it.bookedEnd }}</div>
            </div>

            <div *ngIf="it.pendingExpiresInMinutes" class="text-xs text-amber-600 mt-1">
              Pending reservation expires in {{ it.pendingExpiresInMinutes }} minutes
            </div>
          </div>

          <div class="text-sm text-slate-500">
            <button mat-stroked-button color="primary" (click)="chooseResponseItemDirect(it)">Select</button>
          </div>
        </div>
      </mat-list-option>
    </mat-selection-list>

    <div class="flex justify-between items-center mt-4">
      <button mat-button (click)="cancel()">Cancel</button>
      <div>
        <button mat-flat-button color="primary" [disabled]="!selectedItem" (click)="step='details'">Continue</button>
      </div>
    </div>
  </div>

  <!-- STEP: details form -->
  <div *ngIf="step === 'details'">
    <h3 class="text-lg font-semibold">Booking details</h3>

    <form *ngIf="detailsForm" [formGroup]="detailsForm" (ngSubmit)="proceedToConfirm()" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <!-- Optional service -->
        <mat-form-field  class="w-full custom-mat-input">
          <mat-label>Optional service</mat-label>
          <mat-select formControlName="optionalServiceId">
            <mat-option [value]="null">None</mat-option>
            <mat-option *ngFor="let s of optionalServices" [value]="s.serviceId">
              {{ s.optionalServiceName }} â€” {{ s.price | number:'1.0-0' }} TZS
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Customer type -->
        <mat-form-field  class="w-full custom-mat-input">
          <mat-label>Customer type</mat-label>
          <mat-select formControlName="customerType">
            <mat-option value="INDIVIDUAL">Individual</mat-option>
            <mat-option value="ORGANIZATION">Organization</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Customer name -->
        <mat-form-field  class="w-full custom-mat-input">
          <mat-label>Customer name</mat-label>
          <input matInput formControlName="customerName" />
          <mat-error *ngIf="detailsForm.get('customerName')?.invalid && detailsForm.get('customerName')?.touched">Required</mat-error>
        </mat-form-field>

        <!-- Phone -->
        <mat-form-field  class="w-full custom-mat-input">
          <mat-label>Phone</mat-label>
          <input matInput formControlName="phoneNumber" />
          <mat-error *ngIf="detailsForm.get('phoneNumber')?.invalid && detailsForm.get('phoneNumber')?.touched">Required</mat-error>
        </mat-form-field>

        <!-- Email -->
        <mat-form-field  class="w-full custom-mat-input">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" />
          <mat-error *ngIf="detailsForm.get('email')?.invalid && detailsForm.get('email')?.touched">Valid email required</mat-error>
        </mat-form-field>

        <!-- Address -->
        <mat-form-field  class="w-full custom-mat-input">
          <mat-label>Address</mat-label>
          <input matInput formControlName="address" />
        </mat-form-field>
      </div>

      <!-- Reference document for organizations -->
      <div *ngIf="detailsForm.get('customerType')?.value === 'ORGANIZATION'" class="mt-2">
        <label class="block mb-1 text-sm font-medium">Reference document (PDF)</label>
        <input type="file" (change)="onFileSelected($event)" accept="application/pdf" />
        <div *ngIf="fileError" class="text-red-600 text-sm mt-1">{{ fileError }}</div>
      </div>

      <!-- Employee verify checkbox -->
      <div class="flex items-center gap-3 mt-2">
        <mat-checkbox [checked]="employeeChecked" (change)="onEmployeeCheckboxChange($event)">
          I am an employee of ZSSF (verify for 25% discount)
        </mat-checkbox>
        <div class="text-sm">
          <span *ngIf="isEmployeeVerified" class="text-green-600"><i-lucide-check-circle class="inline-block mr-1"></i-lucide-check-circle> Verified</span>
          <span *ngIf="!isEmployeeVerified" class="text-slate-500">Not verified</span>
        </div>
      </div>

      <div class="flex justify-between items-center mt-4">
        <button mat-button type="button" (click)="cancel()">Cancel</button>
        <button mat-flat-button color="primary" type="submit" >Proceed to confirmation</button>
      </div>
    </form>
  </div>

  <!-- STEP: submitting -->
  <div *ngIf="step === 'submitting'">
    <div class="py-8 text-center">
      <mat-progress-spinner diameter="48" mode="indeterminate"></mat-progress-spinner>
      <div class="mt-3">Submitting booking...</div>
    </div>
  </div>
</mat-dialog-content>
