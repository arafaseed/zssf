<!-- Title -->
<h2 mat-dialog-title class="flex items-center justify-between gap-3">
  <span class="font-semibold">Check availability — {{ data?.venueName }}</span>
  <button mat-icon-button aria-label="close" (click)="cancel()">
    <i-lucide-x class="w-5 h-5"></i-lucide-x>
  </button>
</h2>

<mat-dialog-content class="px-4 py-3 max-h-[70vh] overflow-auto">
  <!-- Loading -->
  <div *ngIf="loading" class="py-8 flex justify-center">
    <mat-progress-spinner diameter="44" mode="indeterminate"></mat-progress-spinner>
  </div>

  <!-- Error -->
  <div *ngIf="!loading && errorMsg" class="text-red-600 py-2">
    {{ errorMsg }}
  </div>

  <!-- Results -->
  <div *ngIf="!loading && availability?.length">
    <!-- If everything is free, show banner but still show list so user can inspect -->
    <div *ngIf="allAvailable" class="mb-3 p-3 rounded-lg bg-emerald-50 border border-emerald-100 flex items-center gap-3">
      <i-lucide-check-circle class="w-5 h-5 text-emerald-600"></i-lucide-check-circle>
      <div>
        <div class="font-medium">All days in your range are available</div>
        <div class="text-sm text-slate-600">You may continue with the full range or inspect individual days below.</div>
      </div>
    </div>

    <p class="text-sm text-slate-600 mb-2">Select a day to continue, or press <strong>Continue with full range</strong> if available.</p>

    <mat-selection-list>
      <mat-list-option *ngFor="let it of availability" class="py-2">
        <div class="flex items-start justify-between gap-4 w-full">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <div class="font-medium">{{ it.date }}</div>
              <div *ngIf="it.flag === 'AVAILABLE_FOR_BOOKING'" class="text-sm text-emerald-600 flex items-center gap-1">
                <i-lucide-check-circle class="w-4 h-4"></i-lucide-check-circle> Available
              </div>
              <div *ngIf="it.flag === 'ALREADY_BOOKED'" class="text-sm text-rose-600 flex items-center gap-1">
                <i-lucide-x-circle class="w-4 h-4"></i-lucide-x-circle> Booked
              </div>
            </div>

            <div *ngIf="it.flag === 'ALREADY_BOOKED'" class="text-xs text-slate-600 mt-1">
              Booking: {{ it.bookingCode ?? ('#' + (it.bookingId || 'N/A')) }} • Status: {{ it.status }}
              <div *ngIf="it.bookedStart">Booked time: {{ it.bookedStart }} - {{ it.bookedEnd }}</div>
            </div>

            <div *ngIf="it.pendingExpiresInMinutes" class="text-xs text-amber-600 mt-1">
              Pending expires in {{ it.pendingExpiresInMinutes }} minutes
            </div>
          </div>

          <div class="flex-shrink-0 flex flex-col items-end gap-2">
            <button mat-stroked-button color="primary" (click)="selectItem(it)">
              Select
            </button>
          </div>
        </div>
      </mat-list-option>
    </mat-selection-list>
  </div>

  <div *ngIf="!loading && (!availability || availability.length === 0)" class="text-slate-600">
    No availability information returned for this range.
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end" class="px-4 pb-3">
  <div class="flex items-center gap-3 w-full justify-between">
    <button mat-button (click)="cancel()">Cancel</button>

    <div class="flex items-center gap-2">
      <button mat-stroked-button color="primary" (click)="check()" class="mr-2">Refresh</button>
      <button mat-flat-button color="primary" (click)="continueWithRange()" [disabled]="!allAvailable">
        Continue with full range
      </button>
    </div>
  </div>
</mat-dialog-actions>
